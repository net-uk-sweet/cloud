function RouteConfig(a){"use strict";a.when("/cloud",{templateUrl:"js/partials/cloud.html",controller:"CloudCtrl"}).when("/admin",{templateUrl:"js/partials/admin.html",controller:"AdminCtrl"}).otherwise({redirectTo:"/cloud"})}function AdminCtrl(a,b){"use strict";function c(){b.getStats().then(function(b){a.lastUpdated=b.lastUpdated,a.currentCount=b.currentCount,a.latestItem=b.latestItem},g)}function d(){a.lastUpdated="Updating ...",b.updateMedia().then(c,g)}function e(){return b.getImage(a.latestItem,"Medium")}function f(){return b.getTitle(a.latestItem)}function g(b){a.status=b}a.lastUpdated="",a.currentCount="",a.latestItem="",a.getTitle=f,a.getImage=e,a.update=d,c()}function CloudCtrl(a,b,c){"use strict";function d(){a.reversed=!a.reversed}function e(){return c.getTitle(a.selected)}function f(){return c.getDescription(a.selected)}function g(a){b.$emit("page",a)}function h(b){var c=parseInt(a.timeRatio,10)+b*a.steps;c<a.minZoom&&(c=a.minZoom),c>a.maxZoom&&(c=a.maxZoom),a.timeRatio=c}function i(){return null!==a.selected}a.debug=!1,a.media=[],a.selected=null,a.date="",a.timeRatio=4100,a.steps=100,a.maxZoom=1e4,a.minZoom=200,a.paused=!1,a.animating=!1,a.reversed=!1,a.loading=!1,a.loaded=!1,a.zoomed=!1,a.reverse=d,a.getTitle=e,a.getDescription=f,a.page=g,a.zoom=h,a.isUIDisabled=i,c.getMedia().then(function(b){a.media=b},function(a){console.log(a)})}function swAutoFire(a){"use strict";return{restrict:"A",scope:{},link:function(b,c,d){function e(){j=a(function(){c.triggerHandler(k),o=o===n?n:o+1,i=1e3/(m-Math.cos(o/n*(Math.PI/2))*p),e()},o?i:0)}function f(){o=0,a.cancel(j)}function g(){e()}function h(){f()}var i,j,k=d.event||"click",l=b.$eval(d.minSpeed)||1,m=b.$eval(d.maxSpeed)||10,n=b.$eval(d.steps)||10,o=0,p=m-l;c.on("mousedown",g),c.on("mouseup mouseout",h)}}}function swCloud(a,b,c){"use strict";return{restrict:"E",scope:{debug:"=",media:"=",selected:"=",date:"=",loading:"=",loaded:"=",zoomed:"=",paused:"=",animating:"=",reversed:"=",timeRatio:"=",setSelected:"&"},controller:["$scope",function(a){function b(b){return a.selected===b}var c=null;a.updateDate=function(b){b!==c&&(c=b,a.$evalAsync(function(){a.date=c.format("DD-MMMM-YYYY")}))},a.tagClickHandler=function(b){a.$apply(function(){a.selected=b})},a.isLoading=function(c){return a.loading&&b(c)},a.isLoaded=function(c){return a.loaded&&b(c)}}],link:function(d,e){function g(){var a=angular.element(c);h(),i(),m(),e.bind("mouseover",A),e.bind("mouseout",B),e.bind("mousemove",C),a.bind("mousewheel DOMMouseScroll",D),a.bind("resize",E)}function h(){E(),M=L=moment(),O=N=moment(d.media[0].dates.taken),K={x:R/2,y:S/2,z:Y},H=new THREE.CSS3DRenderer,H.setSize(R,S),e.append(H.domElement),G=new THREE.Scene,I=new THREE.PerspectiveCamera(T,R/S,U,V),I.position.set(K.x,K.y,K.z),G.add(I),J=I.position,THREEx.WindowResize.bind(H,I)}function i(){var a,b,c,e;angular.forEach(d.media,function(f){a=document.createElement("div"),b=moment(f.dates.taken),e=j(b),c=new THREE.CSS3DObject(a),c.position.x=e.x,c.position.y=e.y,c.position.z=e.z,a.id=f.id,a.className="tag fade",a.textContent=d.debug?f.dates.taken:f.title._content,a.setAttribute("data-content",a.textContent),a.addEventListener("click",function(a){return function(){d.tagClickHandler(a)}}(f)),f.display=c,f.position=e,f.date=b,G.add(c)})}function j(a){var b=k(a,M);return{x:Math.random()*R,y:Math.random()*S,z:b*P}}function k(a,b){return(a.clone().valueOf()-b.clone().valueOf())/1e3|0}function l(a,b){return a.clone().seconds(a.seconds()+b)}function m(){requestAnimationFrame(m),n()}function n(){var a,b,c,e,f;if(d.paused||(J.x+=(K.x-J.x)/W,J.y+=(K.y-J.y)/W,J.z+=(K.z-J.z)/W),d.animating&&!d.paused){e=d.media.length,f=!0;for(var g=e-1;g>=0;g--)b=d.media[g],c=(b.position.z-b.display.position.z)/W,b.display.position.z+=c,Math.abs(b.position.z-b.display.position.z)<<1&&(f=!1);d.animating=!f}d.animating||(a=(J.z-Y)/P,d.reversed&&(a*=-1),d.updateDate(l(M,a))),H.render(G,I)}function o(a){d.paused=!0,TweenLite.killTweensOf(J),TweenLite.to(I.position,1,{z:a.display.position.z+Y,x:a.display.position.x,y:a.display.position.y,onComplete:F})}function p(){d.animating=!0,d.paused=!1,d.selected=null}function q(){var a=k(L,N)*Math.abs(P)*-1;p(),angular.forEach(d.media,function(b){b.position.z=a-b.position.z})}function r(a){p(),angular.forEach(d.media,function(b){b.position.z=b.position.z/a*P})}function s(a){K.z-=a*X}function t(){K.x=R/2,K.y=S/2}function u(a){var b=y();b&&b.addClass(a)}function v(a){var b=y();b&&b.removeClass(a)}function w(){z().removeClass("disabled")}function x(){z().addClass("disabled"),d.selected&&y().removeClass("disabled")}function y(){return angular.element(document.getElementById(d.selected.id))}function z(){return angular.element(document.querySelectorAll(".tag"))}function A(){Q=!0}function B(){Q=!0,t()}function C(a){Q&&(K.x=R-a.clientX,K.y=a.clientY)}function D(a){var b,c=a.detail,e=a.wheelDelta,g=225,h=g-1;c=c?e&&(f=e/c)?c/f:-c/1.35:e/120,c=1>c?-1>c?(-Math.pow(c,2)-h)/g:c:(Math.pow(c,2)+h)/g,b=Math.min(Math.max(c/2,-1),1),d.$apply(function(){s(b)})}function E(){R=e[0].offsetWidth,S=e[0].offsetHeight}function F(){var a=moment(d.selected.dates.taken);d.updateDate(a),x(),b(function(){d.zoomed=!0},2e3)}var G,H,I,J,K,L,M,N,O,P,Q,R,S,T=30,U=1,V=1e3,W=50,X=3e3,Y=2500,Z=d.$watch("media",function(){d.media.length&&(g(),Z())});d.$watch("selected",function(a,b){a&&a!==b&&(u("selected"),o(a))}),d.$watch("loading",function(a,b){a&&a!==b&&(console.log("Adding class loading to:",y()),u("loading"))}),d.$watch("paused",function(a,b){a||a===b||w()}),d.$watch("reversed",function(a,b){a!==b&&(M=d.reversed?N:L,O=d.reversed?L:N,q())}),d.$watch("zoomed",function(a,b){a||a===b||(v("selected"),v("loading"),u("visited"))}),d.$watch("timeRatio",function(a,b){var c=P;P=1/a,a!==b&&(K.z=Y+(K.z-Y)/c*P,r(c))}),a.$on("page",function(a,b){s(b)})}}}function swMedia(a,b,c){"use strict";return{restrict:"E",scope:{selected:"=",loading:"=",loaded:"=",zoomed:"=",paused:"="},controller:["$scope",function(a){a.getSelectedImage=function(){return b.getImage(a.selected,"Large")||b.getImage(a.selected,"Original")}}],link:function(b,d){function e(a){jss.set(l,{width:a+"%",opacity:"1"})}function f(a){e(100*a)}function g(c){a(function(){b.loaded=!0,b.loading=!1,m.src=c,d.css("background-image","url("+m.src+")")},1e3)}function h(){b.$apply(function(){b.zoomed=!1,b.loaded=!1})}function i(){b.zoomed||b.$apply(function(){b.paused=!1,b.selected=null})}var j,k=["transitionend","webkitTransitionEnd","oTransitionEnd","MSTransitionEnd"].join(" "),l=".tag.loading:before",m=new Image;b.$watch("zoomed",function(a,d){a&&a!==d&&(j=b.getSelectedImage(),b.loading=!0,jss.remove(),c.load(j,f).then(g))}),d.on("click",h),d.on(k,i)}}}function ImageService(a,b){"use strict";function c(a,c){var d=b.defer(),e=0,f=new XMLHttpRequest;return f.open("GET",a,!0),f.responseType="arraybuffer",f.onload=function(){var a=new Blob([this.response]);d.resolve(window.URL.createObjectURL(a))},f.onprogress=function(a){e=a.loaded/1e3,c(e)},f.onError=function(a){d.reject(a)},f.send(),d.promise}return{load:c}}function MediaService(a,b){"use strict";function c(){var b=a({method:"get",url:"data.json"});return b.then(j,i)}function d(){var b=a({method:"get",url:"api/stats"});return b.then(j,i)}function e(){var b=a({method:"post",url:"api/media"});return b.then(j,i)}function f(a,b){var c="localhost"===window.location.hostname?"api/proxy/?url=":"";return a&&c+(_.findWhere(a.size,{label:b})||_.findWhere(a.size,{label:"Original"})).source}function g(a){return a&&a.title._content||""}function h(a){return a&&a.description._content||""}function i(a){return b.reject(a.data)}function j(a){return a.data}return{getMedia:c,getStats:d,updateMedia:e,getImage:f,getTitle:g,getDescription:h}}angular.module("cloudApp",["ngRoute","ngAnimate"]).config(["$routeProvider",RouteConfig]),angular.module("cloudApp").controller("AdminCtrl",AdminCtrl),AdminCtrl.$inject=["$scope","MediaService"],angular.module("cloudApp").controller("CloudCtrl",CloudCtrl),CloudCtrl.$inject=["$scope","$rootScope","MediaService"],angular.module("cloudApp").directive("swAutoFire",swAutoFire),swAutoFire.$inject=["$timeout"],angular.module("cloudApp").directive("swCloud",swCloud),swCloud.$inject=["$rootScope","$timeout","$window"],angular.module("cloudApp").directive("swMedia",swMedia),swMedia.$inject=["$timeout","MediaService","ImageService"];var jss=function(){function a(a){for(var b=a.cssRules||a.rules||[],c={},d=0;d<b.length;d++){var e=f(b[d].selectorText);c[e]||(c[e]=[]),c[e].push({sheet:a,index:d,style:b[d].style})}return c}function b(a,b){var c=a.cssRules||a.rules||[],d=[];b=b.toLowerCase();for(var e=0;e<c.length;e++){var f=c[e].selectorText;!f||f!=b&&f!=l(b)&&f!=m(b)||d.push({sheet:a,index:e,style:c[e].style})}return d}function c(a,b){var c=a.cssRules||a.rules||[],f=c.length,g=e(a,b,c,f);return g||d(a,b,f),{sheet:a,index:f,style:c[f].style}}function d(a,b,c){a.insertRule?a.insertRule(b+" { }",c):a.addRule(b,null,c)}function e(a,b,c,e){var h,i;if(t.exec(b))h=b,i=g(b);else{if(!u.exec(b))return!1;h=f(b),i=b}return r||(d(a,h,e),c.length<=e&&(r=!0)),r&&d(a,i,e),!0}function f(a){return a.replace(u,function(a,b,c,d){return b+"::"+d})}function g(a){return a.replace(t,function(a,b,c){return":"+c})}function h(a){var b=a.sheet;b.deleteRule?b.deleteRule(a.index):b.removeRule&&b.removeRule(a.index)}function i(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function j(a){for(var b={},c=0;c<a.length;c++)i(b,k(a[c].style));return b}function k(a){for(var b={},c=0;c<a.length;c++)b[a[c]]=a[o(a[c])];return b}function l(a){for(var b="",c=0;null!=(match=s.exec(a))&&""!==match[0];)b+=a.substring(c,match.index),b+=a.substr(match.index+match[1].length,match[2].length),b+=a.substr(match.index,match[1].length),c=match.index+match[0].length;return b+=a.substr(c)}function m(a){return t.exec(a)?g(a):a}function n(a,b){for(var c in b){var d=b[c],e=d.indexOf(" !important");a.style.removeProperty(c),e>0?a.style.setProperty(c,d.substr(0,e),"important"):a.style.setProperty(c,d)}}function o(a){return a.replace(/-([a-z])/g,function(a,b){return b.toUpperCase()})}function p(a){var b={};for(var c in a)b[q(c)]=a[c];return b}function q(a){return a.replace(/([A-Z])/g,function(a,b){return"-"+b.toLowerCase()})}var r,s=/((?:\.|#)[^\.\s#]+)((?:\.|#)[^\.\s#]+)/g,t=/(::)(before|after|first-line|first-letter|selection)/,u=/([^:])(:)(before|after|first-line|first-letter|selection)/,v=function(a){this.doc=a,this.head=this.doc.head||this.doc.getElementsByTagName("head")[0],this.sheets=this.doc.styleSheets||[]};v.prototype={get:function(c){if(!this.defaultSheet)return{};if(c)return j(b(this.defaultSheet,c));var d=a(this.defaultSheet);for(c in d)d[c]=j(d[c]);return d},getAll:function(a){for(var c={},d=0;d<this.sheets.length;d++)i(c,j(b(this.sheets[d],a)));return c},set:function(a,d){this.defaultSheet||(this.defaultSheet=this._createSheet()),d=p(d);var e=b(this.defaultSheet,a);e.length||(e=[c(this.defaultSheet,a)]);for(var f=0;f<e.length;f++)n(e[f],d)},remove:function(a){if(this.defaultSheet){if(!a)return this._removeSheet(this.defaultSheet),void delete this.defaultSheet;for(var c=b(this.defaultSheet,a),d=0;d<c.length;d++)h(c[d]);return c.length}},_createSheet:function(){var a=this.doc.createElement("style");return a.type="text/css",a.rel="stylesheet",this.head.appendChild(a),a.sheet},_removeSheet:function(a){var b=a.ownerNode;b.parentNode.removeChild(b)}};var w=new v(document);return w.forDocument=function(a){return new v(a)},w}();"undefined"!=typeof module&&module.exports&&(module.exports=jss),THREE.CSS3DObject=function(a){THREE.Object3D.call(this),this.element=a,this.element.style.position="absolute",this.element.style.WebkitTransformStyle="preserve-3d",this.element.style.MozTransformStyle="preserve-3d",this.element.style.oTransformStyle="preserve-3d",this.element.style.transformStyle="preserve-3d",this.addEventListener("removed",function(a){if(null!==this.element.parentNode){this.element.parentNode.removeChild(this.element);for(var b=0,c=this.children.length;c>b;b++)this.children[b].dispatchEvent(a)}})},THREE.CSS3DObject.prototype=Object.create(THREE.Object3D.prototype),THREE.CSS3DSprite=function(a){THREE.CSS3DObject.call(this,a)},THREE.CSS3DSprite.prototype=Object.create(THREE.CSS3DObject.prototype),THREE.CSS3DRenderer=function(){var a,b,c,d,e=new THREE.Matrix4,f=document.createElement("div");f.style.overflow="hidden",f.style.WebkitTransformStyle="preserve-3d",f.style.MozTransformStyle="preserve-3d",f.style.oTransformStyle="preserve-3d",f.style.transformStyle="preserve-3d",this.domElement=f;var g=document.createElement("div");g.style.WebkitTransformStyle="preserve-3d",g.style.MozTransformStyle="preserve-3d",g.style.oTransformStyle="preserve-3d",g.style.transformStyle="preserve-3d",f.appendChild(g),this.setSize=function(e,h){a=e,b=h,c=a/2,d=b/2,f.style.width=e+"px",f.style.height=h+"px",g.style.width=e+"px",g.style.height=h+"px"};var h=function(a){return Math.abs(a)<1e-6?0:a},i=function(a){var b=a.elements;return"matrix3d("+h(b[0])+","+h(-b[1])+","+h(b[2])+","+h(b[3])+","+h(b[4])+","+h(-b[5])+","+h(b[6])+","+h(b[7])+","+h(b[8])+","+h(-b[9])+","+h(b[10])+","+h(b[11])+","+h(b[12])+","+h(-b[13])+","+h(b[14])+","+h(b[15])+")"},j=function(a){var b=a.elements;return"translate3d(-50%,-50%,0) matrix3d("+h(b[0])+","+h(b[1])+","+h(b[2])+","+h(b[3])+","+h(-b[4])+","+h(-b[5])+","+h(-b[6])+","+h(-b[7])+","+h(b[8])+","+h(b[9])+","+h(b[10])+","+h(b[11])+","+h(b[12])+","+h(b[13])+","+h(b[14])+","+h(b[15])+")"},k=function(a,b){if(a instanceof THREE.CSS3DObject){var c;a instanceof THREE.CSS3DSprite?(e.copy(b.matrixWorldInverse),e.transpose(),e.copyPosition(a.matrixWorld),e.scale(a.scale),e.elements[3]=0,e.elements[7]=0,e.elements[11]=0,e.elements[15]=1,c=j(e)):c=j(a.matrixWorld);var d=a.element;d.style.WebkitTransform=c,d.style.MozTransform=c,d.style.oTransform=c,d.style.transform=c,d.parentNode!==g&&g.appendChild(d)}for(var f=0,h=a.children.length;h>f;f++)k(a.children[f],b)};this.render=function(a,e){var h=.5/Math.tan(THREE.Math.degToRad(.5*e.fov))*b;f.style.WebkitPerspective=h+"px",f.style.MozPerspective=h+"px",f.style.oPerspective=h+"px",f.style.perspective=h+"px",a.updateMatrixWorld(),void 0===e.parent&&e.updateMatrixWorld(),e.matrixWorldInverse.getInverse(e.matrixWorld);var j="translate3d(0,0,"+h+"px)"+i(e.matrixWorldInverse)+" translate3d("+c+"px,"+d+"px, 0)";g.style.WebkitTransform=j,g.style.MozTransform=j,g.style.oTransform=j,g.style.transform=j,k(a,e)}};var THREEx=THREEx||{};THREEx.WindowResize=function(a,b){var c=function(){a.setSize(window.innerWidth,window.innerHeight),b.aspect=window.innerWidth/window.innerHeight,b.updateProjectionMatrix()};return window.addEventListener("resize",c,!1),{stop:function(){window.removeEventListener("resize",c)}}},THREEx.WindowResize.bind=function(a,b){return THREEx.WindowResize(a,b)},angular.module("cloudApp").service("ImageService",ImageService),ImageService.$inject=["$http","$q"],angular.module("cloudApp").service("MediaService",MediaService),MediaService.$inject=["$http","$q"];